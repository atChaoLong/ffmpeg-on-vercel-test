# 视频水印添加工具

这是一个基于 Next.js 和 FFmpeg 的视频水印添加工具，支持上传视频到 Cloudflare R2 存储并添加自定义水印。

## 功能特性

- 🎥 支持多种视频格式上传（MP4, WebM, AVI 等）
- 🖼️ 7种预设水印图片可选
- 📍 5种水印位置设置（左上角、右上角、左下角、右下角、中心）
- 🎛️ 可调节水印透明度和缩放比例
- 📱 响应式设计，支持移动端
- ⚡ 实时处理状态显示
- 💾 自动保存到 Cloudflare R2 和 Supabase

## 技术栈

- **前端**: Next.js 15, React 19, TypeScript, Tailwind CSS
- **后端**: Next.js API Routes
- **视频处理**: FFmpeg
- **存储**: Cloudflare R2 (S3 兼容)
- **数据库**: Supabase (PostgreSQL)
- **部署**: Vercel

## 环境配置

在项目根目录创建 `.env.local` 文件：

```bash
# Cloudflare R2 配置
CLOUDFLARE_R2_ACCESS_KEY_ID=your_access_key_id
CLOUDFLARE_R2_SECRET_ACCESS_KEY=your_secret_access_key
CLOUDFLARE_R2_BUCKET_NAME=your_bucket_name
CLOUDFLARE_R2_ACCOUNT_ID=your_account_id

# Supabase 配置
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_supabase_anon_key
NEXT_PUBLIC_SUPABASE_URL=your_supabase_url
```

## 数据库表结构

```sql
create table public.ffmpeg_on_vercel_test (
  id bigint generated by default as identity not null,
  video_url text null,
  watermark_video_url text null,
  created_at timestamp with time zone not null default now(),
  updated_at timestamp with time zone null default now(),
  watermark_url text null,
  status text null,
  error_message text null,
  constraint ffmpeg_on_vercel_test_pkey primary key (id)
) TABLESPACE pg_default;
```

## 安装和运行

1. 安装依赖：
```bash
npm install
```

2. 配置环境变量（见上方环境配置）

3. 运行开发服务器：
```bash
npm run dev
```

4. 构建生产版本：
```bash
npm run build
npm start
```

## 使用流程

1. **上传视频**: 点击"选择视频文件"按钮，选择要处理的视频文件
2. **配置水印**: 
   - 选择水印图片（7种预设可选）
   - 设置水印位置
   - 调整透明度和缩放比例
   - 选择输出格式（MP4 或 WebM）
3. **添加水印**: 点击"添加水印"按钮开始处理
4. **查看结果**: 处理完成后可以预览和下载带水印的视频

## API 接口

### 视频上传
- **POST** `/api/video/upload`
- 上传视频文件到 Cloudflare R2

### 水印处理
- **POST** `/api/video/watermark`
- 为指定视频添加水印

### 状态查询
- **GET** `/api/video/status?videoId={id}`
- 查询视频处理状态

## 水印图片

项目包含以下预设水印图片：
- `kling.png` - Kling
- `luma.png` - Luma
- `pika.png` - Pika
- `runway.png` - Runway
- `stability.png` - Stability
- `veo.png` - Veo
- `vidu.png` - Vidu

## 部署到 Vercel

1. 将代码推送到 GitHub
2. 在 Vercel 中导入项目
3. 配置环境变量
4. 部署

## 注意事项

- 视频文件大小限制：100MB
- 支持的视频格式：所有 FFmpeg 支持的格式
- 处理时间取决于视频长度和复杂度
- 确保 Cloudflare R2 和 Supabase 配置正确

## 故障排除

### 常见问题

1. **FFmpeg 错误**: 检查 `ffmpeg-static` 是否正确安装
2. **上传失败**: 检查 Cloudflare R2 配置和权限
3. **数据库错误**: 检查 Supabase 连接和表结构
4. **水印处理失败**: 检查视频格式是否支持

### 日志查看

在 Vercel 部署中，可以通过 Vercel 仪表板查看函数日志来调试问题。

## 许可证

MIT License

## 贡献

欢迎提交 Issue 和 Pull Request！
